#!/usr/bin/python3

# Interestingness test for crashes

import os
import subprocess
import sys
import time

# Compile with the unmutated compiler, timing how long this takes
compile_start = time.time()
result = subprocess.run(
    ["{{ mutated_compiler_executable }}", "-I", "{{ csmith_root }}/runtime", "-I", "{{ csmith_root }}/build/runtime",
     "-O3", "{{ program_to_check }}", "-o", "__regular"], capture_output=True)
compile_end = time.time()

# Compilation with the non-mutated compiler should succeed
if result.returncode != 0:
    sys.exit(1)

# Compile with the mutated compiler, allowing compilation to take substantially longer
try:
    dredd_environment = os.environ.copy()
    dredd_environment["DREDD_ENABLED_MUTATION"] = "{{ mutation_ids }}"
    result = subprocess.run(["{{ mutated_compiler_executable }}", "-fno-crash-diagnostics", "-I", "{{ csmith_root }}/runtime",
                             "-I", "{{ csmith_root }}/build/runtime", "-O3", "{{ program_to_check }}", "-o", "__mutated"],
                            capture_output=True,
                            timeout=max({{min_timeout_for_mutant_compilation}},
                                        {{timeout_multiplier_for_mutant_compilation}} * (compile_end - compile_start)),
                            env=dredd_environment)
    if result.returncode == 0:
        # Compilation with the mutated compiler succeeded, which is not
        # interesting as we are looking for a mutation-induced
        # compiler crash
        sys.exit(2)
except subprocess.TimeoutExpired:
    # Compilation with the mutated compiler timed out, which is not
    # interesting as we are looking for a mutation-induced
    # compiler crash
    sys.exit(3)

sys.exit(0)
